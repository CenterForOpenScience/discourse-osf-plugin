<script>
var observeDOM = (function(){
    var MutationObserver = window.MutationObserver || window.WebKitMutationObserver,
        eventListenerSupported = window.addEventListener;

    return function(obj, callback){
        if( MutationObserver ){
            // define a new observer
            var obs = new MutationObserver(function(mutations, observer){
                if( mutations[0].addedNodes.length || mutations[0].removedNodes.length )
                    callback();
            });
            // have the observer observe foo for changes in children
            obs.observe( obj, { childList:true, subtree:true });
        }
    }
})();

// Observe a specific DOM element:
observeDOM(document.body, function() {
    var topic_post = document.querySelector('.topic-post article#post_1 .cooked');
    if (!topic_post) return;
    if (document.getElementById('mfrButton')) return;

    var mfrDomain = Discourse.SiteSettings.mfr_domain;
    var osfDomain = Discourse.SiteSettings.osf_domain;

    var reg = new RegExp('\:\/\/(?:osf|local)[^\/]*\/([a-z0-9]*)\/?');
    var match = reg.exec(topic_post.textContent);
    if (match) {
        var guid = match[1];

        var mfrButton = document.createElement('button');
        mfrButton.id = 'mfrButton';
        mfrButton.appendChild(document.createTextNode('Show File View'));
        topic_post.appendChild(mfrButton);

        var showMfrView = function() {
            var mfrJs = document.createElement('script');
            mfrJs.src = mfrDomain + '/static/js/mfr.js';
            mfrJs.onload = function() {
                var mfrRender = new mfr.Render('mfrIframe', mfrDomain + '/render?url=' + osfDomain + '/' + guid + '/?action=download%26mode=render');
                mfrButton.style.display = 'None';
            };
            document.head.appendChild(mfrJs);
        }

        mfrButton.onclick = function() {
            var mfrDiv = document.createElement('div');
            mfrDiv.id = 'mfrIframe';
            mfrDiv.className = 'mfr mfr-file';
            topic_post.appendChild(mfrDiv);

            var mfrCss = document.createElement('link');
            mfrCss.href = mfrDomain + '/static/css/mfr.css';
            mfrCss.media = 'all';
            mfrCss.rel = 'stylesheet';
            document.head.appendChild(mfrCss)

            if (!window.jQuery) {
                var jqScript = document.createElement('script');
                jqScript.src = '//code.jquery.com/jquery-1.11.2.min.js';
                jqScript.onload = showMfrView;
                document.head.appendChild(jqScript);
            } else {
                showMfrView();
            }
        }
    }
});
</script>
